 {% extends 'base.html.twig' %}

{% block title %}Tableau de Bord Employé{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
.selected-package {
    background-color: #e3f2fd !important;
    border-color: #5e6a74ff !important;
    width: 100% !important;
}

/* Mobile Menu Styles */
.mobile-menu-toggle {
    display: none;
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 0.5rem;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.mobile-menu-toggle:hover {
    background: rgba(255, 255, 255, 0.3);
    border-color: rgba(255, 255, 255, 0.5);
}

.mobile-menu-toggle i {
    font-size: 1.2rem;
}

.mobile-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 999;
}

.mobile-overlay.active {
    display: block;
}

.mobile-menu {
    position: fixed;
    top: 0;
    right: -300px;
    width: 280px;
    height: auto;
    background: white;
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
    transition: right 0.3s ease;
    z-index: 1000;
    padding: 4rem 1rem 1rem;
    display: flex;
    flex-direction: column;
}

.mobile-menu-close {
    position: absolute;
    top: 10px;
    right: 15px;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 0.9rem;
    color: #2c3e50;
    cursor: pointer;
    z-index: 1001;
    padding: 5px 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mobile-menu-close:hover {
    background: rgba(255, 255, 255, 1);
    color: #e74c3c;
}

.mobile-menu.active {
    right: 0;
}

.mobile-menu-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border: none;
    background: none;
    color: #2c3e50;
    text-decoration: none;
    border-radius: 8px;
    transition: background-color 0.3s ease;
    margin-bottom: 0.5rem;
    cursor: pointer;
}

.mobile-menu-item:hover {
    background-color: #f8f9fa;
}

.mobile-menu-item i {
    font-size: 1.2rem;
    color: #3498db;
}

.mobile-menu-item.logout-item {
    margin-top: auto;
    color: #e74c3c;
}

.mobile-menu-item.logout-item i {
    color: #e74c3c;
}

/* Mobile Responsiveness */
@media (max-width: 850px) {
    .mobile-menu-toggle {
        display: block;
    }

    *{
        font-weight:1.5rem;
    }

    h1{
        font-weight:2.5rem;
    }

    h2,h3 {
        font-weight:2rem;
    }

    .container-fluid {
        padding-left: 15px;
        padding-right: 15px;
    }

    .stats-card {
        margin-bottom: 1rem;
        height: auto !important;
        min-height: 150px;
    }

    .row.mb-4.justify-content-center.align-items-center {
        flex-direction: column;
        gap: 1rem;
    }

    .col-md-4 {
        width: 100% !important;
        max-width: 100% !important;
    }

    .card.bg-primary, .card.bg-success, .card.bg-info, .card.bg-warning {
        width: 100%;
    }

    .package-card {
        margin-bottom: 1rem;
    }

    .col-md-6 {
        width: 100% !important;
        max-width: 100% !important;
        margin-bottom: 1rem;
    }

    .btn.btn-success.btn-lg.w-100, .btn.btn-info.btn-lg.w-100 {
        margin-bottom: 1rem;
    }

    .table-responsive {
        font-size: 0.9rem;
    }

    .table-responsive th, .table-responsive td {
        padding: 0.5rem;
    }

    .modal-dialog {
        margin: 0;
        width: 100vw;
        max-width: none;
    }

    .modal-content {
        border-radius: 0;
    }

    /* Logout button styling for mobile */
    .logout-btn-mobile {
        padding: 0.25rem 0.5rem !important;
        font-size: 0.8rem !important;
        border: none !important;
        background: transparent !important;
        color: #ffffff !important;
    }

    .logout-btn-mobile:hover {
        color: #ffffff !important;
        background: rgba(255, 255, 255, 0.1) !important;
    }

    .logout-btn-mobile i {
        font-size: 1.2rem !important;
        color: #ffffff !important;
    }
}

@media (max-width: 480px) {
    h1 {
        font-size: 1.5rem !important;
    }

    .card-title {
        font-size: 1rem;
    }

    .card-text {
        font-size: 1.2rem;
    }

    .btn {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
    }

    .table-responsive {
        font-size: 0.8rem;
    }
}
</style>
{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-4 text-white">Tableau de Bord Employé</h1>
                    <p class="text-white">Bienvenue, {{ app.user.firstName }} {{ app.user.lastName }}</p>
                </div>
                <div class="d-flex align-items-center">
                    <!-- Mobile Menu Toggle -->
                    <button class="mobile-menu-toggle d-md-none me-2" id="mobileMenuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <a href="{{ path('app_logout') }}" class="btn btn-outline-light logout-btn-mobile d-none d-md-inline-block">
                        <i class="fas fa-sign-out-alt me-1"></i>Déconnexion
                    </a>
                    <a href="{{ path('app_logout') }}" class="btn logout-btn-mobile d-md-none" title="Déconnexion">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-overlay" id="mobileOverlay"></div>
    <div class="mobile-menu" id="mobileMenu">
        <button class="mobile-menu-close" id="mobileMenuClose">Fermeture</button>
        <button class="mobile-menu-item" id="showRevenusBtn" data-bs-toggle="modal" data-bs-target="#revenusModal">
            <i class="fas fa-euro-sign"></i>
            <span>Revenus Récents</span>
        </button>
        <button class="mobile-menu-item" id="showCommissionsBtn" data-bs-toggle="modal" data-bs-target="#commissionsModal">
            <i class="fas fa-money-bill-wave"></i>
            <span>Commissions</span>
        </button>
        <a href="{{ path('app_logout') }}" class="mobile-menu-item logout-item">
            <i class="fas fa-sign-out-alt"></i>
            <span>Déconnexion</span>
        </a>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4 justify-content-center align-items-center" style="justify-content: space-evenly;">
        <div class="col-md-4 d-flex justify-content-center" style="width: 30%; height: 34vh;">
            <div class="card bg-primary text-white stats-card" >
                <div class="card-body text-center">
                    <h5 class="card-title">CA Aujourd'hui</h5>
                    <h3 class="card-text">{{ totalCaHt|number_format(2, ',', ' ') }} €</h3>
                    <small>Commission: {{ todayCommission|number_format(2, ',', ' ') }} €</small><br>
                    <small>{{ todayClientsCount }} clients aujourd'hui</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 d-flex justify-content-center" style="width: 30%; height: 34vh;">
            <div class="card bg-success text-white stats-card" >
                <div class="card-body text-center">
                    <h5 class="card-title">Commission Validée du Mois</h5>
                    <h3 class="card-text">{{ totalCommission|number_format(2, ',', ' ') }} €</h3>
                    <small>Sur {{ validatedRevenueHt|number_format(2, ',', ' ') }} € HT validés</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 d-flex justify-content-center" style="width: 30%; height: 34vh;">
            <div class="card bg-warning text-white stats-card" >
                <div class="card-body text-center">
                    <h5 class="card-title">Commission Payée</h5>
                    <h3 class="card-text">{{ validatedCommission|number_format(2, ',', ' ') }} €</h3>
                    <small>Commission payée ce mois-ci</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 d-flex justify-content-center" style="width: 30%; height: 34vh;">
            <div class="card bg-info text-white stats-card" >
                <div class="card-body text-center">
                    <h5 class="card-title">Reste à Payer</h5>
                    <h3 class="card-text">{{ (totalCommission - validatedCommission)|number_format(2, ',', ' ') }} €</h3>
                    <small>{{ pendingClientsCount }} clients depuis dernière validation</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Packages Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Sélection de Forfaits</h5>
                    <button class="btn btn-primary" id="showPackagesBtn" type="button">
                        Voir les Forfaits
                    </button>
                </div>
                <div class="card-body" id="packagesContainer" style="display: none;">
                    <div class="row">
                        {% for packageData in packagesWithCommission %}
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card h-100 border-primary package-card">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ packageData.package.name }}</h6>
                                        <p class="card-text text-muted small">{{ packageData.package.description }}</p>
                                        <div class="mb-2">
                                            <strong>Prix TTC: {{ packageData.package.price|number_format(2, ',', ' ') }} €</strong>
                                        </div>
                                        <div class="mb-2">
                                            <small class="text-muted">Prix HT: {{ packageData.priceHt|number_format(2, ',', ' ') }} €</small>
                                        </div>
                                        <div class="mb-3">
                                            <span class="badge bg-success">Commission: {{ packageData.commission|number_format(2, ',', ' ') }} €</span>
                                        </div>
                                        <button class="btn btn-outline-primary btn-sm w-100 package-btn" data-package-id="{{ packageData.package.id }}" data-price-ht="{{ packageData.priceHt }}" onclick="selectPackage({{ packageData.package.id }}, '{{ packageData.package.name }}', {{ packageData.package.price }}, {{ packageData.commission }}, {{ packageData.priceHt }})">
                                            Sélectionner ce Forfait
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="text-center mt-3" id="packageActions" style="display: none;">
                        <button type="button" class="btn btn-secondary me-2" onclick="closePackages()">Fermer</button>
                        <button type="button" class="btn btn-primary" onclick="confirmPackageSelection()">Confirmer la Sélection</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Today's Appointments -->
    <div class="row mb-4">
        <div class="col-12 appointments-section">
            <div class="card">
                <div class="card-header text-center">
                    <h5 class="mb-0">Rendez-vous d'Aujourd'hui et Demain</h5>
                </div>
                <div class="card-body">
                    {% if todayAppointments is empty %}
                        <p class="text-muted text-center">Aucun rendez-vous prévu pour aujourd'hui.</p>
                    {% else %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th class="text-center">Date & Heure</th>
                                        <th class="text-center">Client</th>
                                        <th class="text-center">Service</th>
                                        <th class="text-center">Contact</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for appointment in todayAppointments %}
                                        <tr>
                                            <td class="text-center">{{ appointment.date|date('d/m/Y H:i') }}</td>
                                            <td class="text-center">{{ appointment.clientName }}</td>
                                            <td class="text-center">{{ appointment.package.name }}</td>
                                            <td class="text-center">
                                                <small>{{ appointment.clientEmail }}</small><br>
                                                <small>{{ appointment.clientPhone }}</small>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Buttons -->
    <div class="row mb-4">
        <div class="col-md-6">
            <button class="btn btn-info btn-lg w-100" data-bs-toggle="modal" data-bs-target="#weeklyStatsModal">
                <i class="fas fa-calendar-week"></i> Statistiques Hebdomadaires
            </button>
        </div>
        <div class="col-md-6" style="margin-top: 4%;">
            <button class="btn btn-success btn-lg w-100" data-bs-toggle="modal" data-bs-target="#monthlyStatsModal">
                <i class="fas fa-calendar-alt"></i> Statistiques Mensuelles
            </button>
        </div>
    </div>

    <!-- Commission History - Desktop Only -->
    <div class="row mb-4 d-none d-md-block">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Historique des Commissions</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Historique des commissions hebdomadaires</p>
                    <div class="text-center mb-3">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#commissionHistoryModal">
                            Voir l'historique complet
                        </button>
                    </div>
                    {% if commissionHistory %}
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th class="text-center">Semaine</th>
                                        <th class="text-center">Revenus HT</th>
                                        <th class="text-center">Commission</th>
                                        <th class="text-center">Clients</th>
                                        <th class="text-center">Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for commission in commissionHistory|slice(0, 3) %}
                                        <tr>
                                            <td class="text-center">{{ commission.weekStart|date('d/m') }} - {{ commission.weekEnd|date('d/m') }}</td>
                                            <td class="text-center">{{ commission.totalRevenueHt|number_format(2, ',', ' ') }} €</td>
                                            <td class="text-center">{{ commission.totalCommission|number_format(2, ',', ' ') }} €</td>
                                            <td class="text-center">{{ commission.clientsCount }}</td>
                                            <td class="text-center">
                                                {% if commission.paid %}
                                                    <span class="badge bg-success">Payée</span>
                                                {% else %}
                                                    <span class="badge bg-warning">En attente</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center">Aucune commission validée trouvée.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Commission Non Validée -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Commission Non Validée</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-2">
                                <strong>Revenus depuis dernière validation: {{ pendingRevenueHt|number_format(2, ',', ' ') }} €</strong>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-2">
                                <small class="text-muted">{{ pendingClientsCount }} clients depuis dernière validation</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <span class="badge bg-warning">Commission: {{ pendingCommission|number_format(2, ',', ' ') }} €</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Weekly Commission Validation -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Validation des Commissions Hebdomadaires</h5>
                    <button class="btn btn-warning" id="validateCommissionBtn" type="button">
                        <i class="fas fa-check-circle"></i> Valider Commission
                    </button>
                </div>
                <div class="card-body" id="commissionValidationContainer" style="display: none;">
                    {% if currentWeekCommission is defined and currentWeekCommission %}
                        <div class="alert alert-info">
                            <h6>Commission de la semaine actuelle ({{ currentWeekCommission.weekStart|date('d/m/Y') }} - {{ currentWeekCommission.weekEnd|date('d/m/Y') }})</h6>
                            <p><strong>Revenus HT:</strong> {{ currentWeekCommission.totalRevenueHt|number_format(2, ',', ' ') }} €</p>
                            <p><strong>Commission ({{ commissionPercentage }}%):</strong> {{ currentWeekCommission.totalCommission|number_format(2, ',', ' ') }} €</p>
                            <p><strong>Clients:</strong> {{ currentWeekCommission.clientsCount }}</p>
                            <p><strong>Statut:</strong>
                                {% if currentWeekCommission.validated %}
                                    <span class="badge bg-success">Validée</span>
                                    {% if currentWeekCommission.paid %}
                                        <span class="badge bg-primary">Payée</span>
                                    {% else %}
                                        <span class="badge bg-warning">En attente de paiement</span>
                                        <br><br>
                                        <button class="btn btn-primary btn-sm" onclick="markCommissionPaid({{ currentWeekCommission.id }})">
                                            <i class="fas fa-money-bill-wave"></i> Confirmer le paiement
                                        </button>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-secondary">En attente de validation</span>
                                {% endif %}
                            </p>
                            {% if not currentWeekCommission.validated %}
                                <button class="btn btn-success btn-sm" onclick="validateWeeklyCommission({{ currentWeekCommission.id }})">
                                    <i class="fas fa-check"></i> Valider cette commission
                                </button>
                            {% endif %}
                        </div>
                    {% else %}
                        <p class="text-muted">Aucune commission disponible pour validation cette semaine.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Revenues - Desktop Only -->
    <div class="row d-none d-md-block" id="revenuesSection">
        <div class="col-12 revenue-section">
            <div class="card">
                <div class="card-header text-center">
                    <h5 class="mb-0">Revenus Récents</h5>
                </div>
                <div class="card-body">
                    {% if recentRevenues is empty %}
                        <p class="text-muted text-center">Aucun revenu enregistré récemment.</p>
                    {% else %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th class="text-center">Date</th>
                                        <th class="text-center">Service</th>
                                        <th class="text-center">Montant HT</th>
                                        <th class="text-center">Commission</th>
                                        <th class="text-center">Montant TTC</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for revenue in recentRevenues %}
                                        {% set commissionAmount = (revenue.amountHt * commissionPercentage / 100) %}
                                        <tr>
                                            <td class="text-center">{{ revenue.date|date('d/m/Y') }}</td>
                                            <td class="text-center">{{ revenue.package.name }}</td>
                                            <td class="text-center">{{ revenue.amountHt|number_format(2, ',', ' ') }} €</td>
                                            <td class="text-center">{{ commissionAmount|number_format(2, ',', ' ') }} €</td>
                                            <td class="text-center"><strong>{{ revenue.amountTtc|number_format(2, ',', ' ') }} €</strong></td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Weekly Stats Modal -->
<div class="modal fade" id="weeklyStatsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Statistiques Hebdomadaires</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if weeklyStats is empty %}
                    <p>Aucune statistique hebdomadaire disponible.</p>
                {% else %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Semaine</th>
                                    <th>Revenus HT</th>
                                    <th>Revenus TTC</th>
                                    <th>Clients</th>
                                    <th>Commission</th>
                                    <th>Profit</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in weeklyStats %}
                                    <tr>
                                        <td>Semaine {{ stat.date|date('W') }} ({{ stat.date|date('d/m/Y') }})</td>
                                        <td>{{ stat.revenueHt }} €</td>
                                        <td>{{ stat.revenueTtc }} €</td>
                                        <td>{{ stat.clientsCount }}</td>
                                        <td>{{ stat.commission }} €</td>
                                        <td class="{% if stat.profit >= 0 %}text-success{% else %}text-danger{% endif %}">{{ stat.profit }} €</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Monthly Stats Modal -->
<div class="modal fade" id="monthlyStatsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Statistiques Mensuelles</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if monthlyStats is empty %}
                    <p>Aucune statistique mensuelle disponible.</p>
                {% else %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Mois</th>
                                    <th>Revenus HT</th>
                                    <th>Revenus TTC</th>
                                    <th>Clients</th>
                                    <th>Commission</th>
                                    <th>Profit</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in monthlyStats %}
                                    <tr>
                                        <td>{{ stat.date|date('M Y') }}</td>
                                        <td>{{ stat.revenueHt }} €</td>
                                        <td>{{ stat.revenueTtc }} €</td>
                                        <td>{{ stat.clientsCount }}</td>
                                        <td>{{ stat.commission }} €</td>
                                        <td class="{% if stat.profit >= 0 %}text-success{% else %}text-danger{% endif %}">{{ stat.profit }} €</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Mobile Modals -->
<!-- Revenus Modal -->
<div class="modal fade" id="revenusModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-euro-sign me-2"></i>Revenus Récents</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if recentRevenues is empty %}
                    <p class="text-muted text-center">Aucun revenu enregistré récemment.</p>
                {% else %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th class="text-center">Date</th>
                                    <th class="text-center">Service</th>
                                    <th class="text-center">Montant HT</th>
                                    <th class="text-center">Commission</th>
                                    <th class="text-center">Montant TTC</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for revenue in recentRevenues %}
                                    {% set commissionAmount = (revenue.amountHt * commissionPercentage / 100) %}
                                    <tr>
                                        <td class="text-center">{{ revenue.date|date('d/m/Y') }}</td>
                                        <td class="text-center">{{ revenue.package.name }}</td>
                                        <td class="text-center">{{ revenue.amountHt|number_format(2, ',', ' ') }} €</td>
                                        <td class="text-center">{{ commissionAmount|number_format(2, ',', ' ') }} €</td>
                                        <td class="text-center"><strong>{{ revenue.amountTtc|number_format(2, ',', ' ') }} €</strong></td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Commissions Modal -->
<div class="modal fade" id="commissionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-money-bill-wave me-2"></i>Historique des Commissions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if commissionHistory is empty %}
                    <p class="text-muted text-center">Aucune commission validée trouvée.</p>
                {% else %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Semaine</th>
                                    <th>Revenus HT</th>
                                    <th>Commission</th>
                                    <th>Clients</th>
                                    <th>Validée le</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for commission in commissionHistory %}
                                    <tr>
                                        <td>{{ commission.weekStart|date('d/m/Y') }} - {{ commission.weekEnd|date('d/m/Y') }}</td>
                                        <td>{{ commission.totalRevenueHt|number_format(2, ',', ' ') }} €</td>
                                        <td>{{ commission.totalCommission|number_format(2, ',', ' ') }} €</td>
                                        <td>{{ commission.clientsCount }}</td>
                                        <td>{{ commission.validatedAt|date('d/m/Y H:i') }}</td>
                                        <td>
                                            {% if commission.paid %}
                                                <span class="badge bg-success">Payée</span>
                                            {% else %}
                                                <span class="badge bg-warning">En attente de paiement</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Commission History Modal - Desktop -->
<div class="modal fade" id="commissionHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Historique des Commissions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if commissionHistory is empty %}
                    <p class="text-muted text-center">Aucune commission validée trouvée.</p>
                {% else %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Semaine</th>
                                    <th>Revenus HT</th>
                                    <th>Commission</th>
                                    <th>Clients</th>
                                    <th>Validée le</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for commission in commissionHistory %}
                                    <tr>
                                        <td>{{ commission.weekStart|date('d/m/Y') }} - {{ commission.weekEnd|date('d/m/Y') }}</td>
                                        <td>{{ commission.totalRevenueHt|number_format(2, ',', ' ') }} €</td>
                                        <td>{{ commission.totalCommission|number_format(2, ',', ' ') }} €</td>
                                        <td>{{ commission.clientsCount }}</td>
                                        <td>{{ commission.validatedAt|date('d/m/Y H:i') }}</td>
                                        <td>
                                            {% if commission.paid %}
                                                <span class="badge bg-success">Payée</span>
                                            {% else %}
                                                <span class="badge bg-warning">En attente de paiement</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
let selectedPackage = null;
let totalCaHt = 0;

function updateCaDisplay() {
    document.getElementById('totalCaHt').textContent = totalCaHt.toFixed(2).replace('.', ',') + ' €';
}

document.getElementById('showPackagesBtn').addEventListener('click', function() {
    const container = document.getElementById('packagesContainer');
    const actions = document.getElementById('packageActions');

    if (container.style.display === 'none') {
        container.style.display = 'block';
        this.textContent = 'Masquer les Forfaits';
        actions.style.display = 'none'; // Hide actions initially
    } else {
        container.style.display = 'none';
        this.textContent = 'Voir les Forfaits';
        actions.style.display = 'none';
    }
});

document.getElementById('validateCommissionBtn').addEventListener('click', function() {
    const container = document.getElementById('commissionValidationContainer');

    if (container.style.display === 'none') {
        container.style.display = 'block';
        this.innerHTML = '<i class="fas fa-times-circle"></i> Masquer Validation';
    } else {
        container.style.display = 'none';
        this.innerHTML = '<i class="fas fa-check-circle"></i> Valider Commission';
    }
});

function selectPackage(id, name, price, commission, priceHt) {
    selectedPackage = { id, name, price, commission, priceHt };

    // Update button states
    document.querySelectorAll('.package-btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
        btn.textContent = 'Sélectionner ce Forfait';
    });

    // Highlight selected button
    const selectedBtn = document.querySelector(`[data-package-id="${id}"]`);
    selectedBtn.classList.remove('btn-outline-primary');
    selectedBtn.classList.add('btn-primary');
    selectedBtn.textContent = 'Forfait Sélectionné';

    // Show actions
    document.getElementById('packageActions').style.display = 'block';
}

function closePackages() {
    document.getElementById('packagesContainer').style.display = 'none';
    document.getElementById('showPackagesBtn').textContent = 'Voir les Forfaits';
    document.getElementById('packageActions').style.display = 'none';

    // Reset selection
    selectedPackage = null;
    document.querySelectorAll('.package-btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
        btn.textContent = 'Sélectionner ce Forfait';
    });
}

function confirmPackageSelection() {
    if (selectedPackage) {
        // Send AJAX request to save the selection
        fetch('/employee/select-package', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: 'package_id=' + selectedPackage.id
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add to CA HT
                totalCaHt += selectedPackage.priceHt;
                updateCaDisplay();

                // Update monthly stats
                updateMonthlyStats();

                // Show success message
                alert(`Forfait "${selectedPackage.name}" ajouté avec succès!\nPrix HT ajouté au CA: ${selectedPackage.priceHt.toFixed(2)} €\nCommission: ${selectedPackage.commission.toFixed(2)} €`);

                // Hide packages and show button again
                closePackages();
            } else {
                alert('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur est survenue lors de la sauvegarde.');
        });
    }
}

function updateMonthlyStats() {
    // Fetch updated stats from server
    fetch('/employee/package-stats')
    .then(response => response.json())
    .then(data => {
        // Update the displayed values
        document.getElementById('totalCaHt').textContent = data.total_ca_ht.toFixed(2).replace('.', ',') + ' €';

        // Update monthly revenue and commission cards
        const monthlyRevenueCard = document.querySelector('.card.bg-primary .card-text');
        const monthlyCommissionCard = document.querySelector('.card.bg-success .card-text');

        if (monthlyRevenueCard) {
            monthlyRevenueCard.textContent = data.total_monthly_revenue.toFixed(2).replace('.', ',') + ' €';
        }
        if (monthlyCommissionCard) {
            monthlyCommissionCard.textContent = data.total_commission.toFixed(2).replace('.', ',') + ' €';
        }
    })
    .catch(error => {
        console.error('Error updating stats:', error);
    });
}

// Initialize CA HT on page load with server data
document.addEventListener('DOMContentLoaded', function() {
    // Set initial CA HT from server
    const initialCaHt = {{ totalCaHt }};
    totalCaHt = initialCaHt;

    updateMonthlyStats();
});

function validateWeeklyCommission(commissionId) {
    if (confirm('Êtes-vous sûr de vouloir valider cette commission ? Cette action est irréversible.')) {
        fetch('/employee/validate-commission', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: 'commission_id=' + commissionId
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Commission validée avec succès ! Elle sera maintenant visible dans le dashboard admin pour paiement.');
                location.reload(); // Reload to update the status
            } else {
                alert('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur est survenue lors de la validation.');
        });
    }
}

function markCommissionPaid(commissionId) {
    if (confirm('Êtes-vous sûr de vouloir marquer cette commission comme payée ? Cette action confirme que le paiement a été effectué.')) {
        fetch('/employee/mark-commission-paid', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: 'commission_id=' + commissionId
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Commission marquée comme payée avec succès !');
                location.reload(); // Reload to update the status
            } else {
                alert('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Une erreur est survenue lors de la confirmation du paiement.');
        });
    }
}

// Mobile menu functionality
document.addEventListener('DOMContentLoaded', function() {
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const mobileMenu = document.getElementById('mobileMenu');
    const mobileOverlay = document.getElementById('mobileOverlay');
    const mobileMenuClose = document.getElementById('mobileMenuClose');

    if (mobileMenuToggle && mobileMenu && mobileOverlay) {
        mobileMenuToggle.addEventListener('click', function() {
            mobileMenu.classList.toggle('active');
            mobileOverlay.classList.toggle('active');
        });

        mobileOverlay.addEventListener('click', function() {
            mobileMenu.classList.remove('active');
            mobileOverlay.classList.remove('active');
        });

        if (mobileMenuClose) {
            mobileMenuClose.addEventListener('click', function() {
                mobileMenu.classList.remove('active');
                mobileOverlay.classList.remove('active');
            });
        }
    }
});
</script>
{% endblock %}
